name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.9'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Data Validation and Testing
  test:
    name: Data Validation & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run data validation tests
      run: |
        echo "Running data validation..."
        python -c "
        import pandas as pd
        import os
        
        # Check if data exists
        assert os.path.exists('data/ci_cd_logs_cleaned.csv'), 'Dataset not found'
        
        # Load and validate
        df = pd.read_csv('data/ci_cd_logs_cleaned.csv')
        
        # Required columns
        required_cols = ['hour', 'day_of_week', 'month', 'stage_encoded', 
                        'job_encoded', 'task_encoded', 'environment_encoded', 'is_failure']
        
        for col in required_cols:
            assert col in df.columns, f'Missing column: {col}'
        
        # Check for nulls
        assert df[required_cols].isnull().sum().sum() == 0, 'Null values found'
        
        # Check target distribution
        failure_rate = df['is_failure'].mean()
        assert 0.1 < failure_rate < 0.5, f'Unusual failure rate: {failure_rate}'
        
        print('✅ All data validation tests passed!')
        "
    
    - name: Check model file structure
      run: |
        mkdir -p models
        echo "✅ Models directory created"

  # Job 2: Model Training
  train:
    name: Train ML Models
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Train models
      run: |
        echo "Training models with MLflow..."
        python train.py
    
    - name: Validate model artifacts
      run: |
        python -c "
        import os
        import joblib
        
        # Check if models were created
        assert os.path.exists('models/best_model.pkl'), 'Best model not found'
        
        # Try loading the model
        model = joblib.load('models/best_model.pkl')
        print(f'✅ Model loaded successfully: {type(model).__name__}')
        
        # Check model has predict method
        assert hasattr(model, 'predict'), 'Model missing predict method'
        assert hasattr(model, 'predict_proba'), 'Model missing predict_proba method'
        
        print('✅ All model validation tests passed!')
        "
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: trained-models
        path: models/
        retention-days: 30

  # Job 3: API Testing
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    needs: train
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: trained-models
        path: models/
    
    - name: Test API endpoints
      run: |
        # Start API in background
        python app.py &
        API_PID=$!
        
        # Wait for API to start
        sleep 10
        
        # Test health endpoint
        curl -f http://localhost:8000/health || exit 1
        
        # Test prediction endpoint
        curl -f -X POST http://localhost:8000/predict \
          -H "Content-Type: application/json" \
          -d '{
            "hour": 14,
            "day_of_week": 2,
            "month": 11,
            "stage_encoded": 1,
            "job_encoded": 2,
            "task_encoded": 1,
            "environment_encoded": 1
          }' || exit 1
        
        # Kill API process
        kill $API_PID
        
        echo "✅ All API tests passed!"

  # Job 4: Build Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: api-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: trained-models
        path: models/
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: mlops-cicd-api:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker image
      run: |
        docker run -d -p 8000:8000 --name test-api mlops-cicd-api:latest
        sleep 10
        curl -f http://localhost:8000/health || exit 1
        docker stop test-api
        docker rm test-api
        echo "✅ Docker image test passed!"

  # Job 5: Deploy to Azure (manual trigger or on main branch)
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: trained-models
        path: models/
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure Container Instances
      run: |
        echo "Deploying to Azure..."
        # Add your Azure deployment commands here
        # Example:
        # az container create \
        #   --resource-group mlops-rg \
        #   --name mlops-api \
        #   --image your-registry/mlops-cicd-api:latest \
        #   --cpu 1 --memory 1 \
        #   --ports 8000
    
    - name: Deployment notification
      run: |
        echo "✅ Deployment complete!"
        echo "API endpoint: https://your-azure-url.com"